name: Docker CD

on:
  push:
    branches:
      - main

  # 실제 실행될 내용들을 정의합니다.
jobs:
  build:
    runs-on: ubuntu-latest # ubuntu 최신 버전에서 script를 실행

    steps:
      # 지정한 저장소(현재 REPO)에서 코드를 워크플로우 환경으로 가져오도록 하는 github action
      - uses: actions/checkout@v4

      - name: create remote directory # ec2 서버에 디렉토리를 하나 만들어준다.
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.AWS_GENERAL_SSH_KEY }}
          script: mkdir -p /home/ubuntu/app/petlink

      - name: copy project # ssh key를 이용해 현재 푸시된 소스를 서버에 복사한다.
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete # rsync 명령어 옵션
          remote_path: /home/ubuntu/app/petlink
          remote_host: ${{ secrets.APP_SERVER_IP }}
          remote_user: ubuntu
          remote_key: ${{ secrets.AWS_GENERAL_SSH_KEY }}

      - name: Set up .env file # 원격서버에 .env 파일을 만들어준다.
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.AWS_GENERAL_SSH_KEY }}
          script: |
            cd /home/ubuntu/app/petlink
            touch ./.env
            echo "${{ secrets.ENV }}" > ./.env

      ## docker compose up
      - name: docker compose up
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.AWS_GENERAL_SSH_KEY }}
          script: |
            sudo docker rm -f $(docker ps -qa) # 기존에 실행되고 있는 컨테이너를 모두 삭제한다.
            sudo docker pull ${{ secrets.DOCKER_ID }}/petlink:latest # docker hub에서 이미지를 가져온다.
            docker-compose up -d # docker-compose.yml 파일을 실행한다.
            docker image prune -f # 사용하지 않는 이미지를 삭제한다.